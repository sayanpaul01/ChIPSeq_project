---
title: "Peak details (TOP2B and P53)"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## **ðŸ“Œ TOP2B peaks (before deduplication)**
```{r TOP, echo=TRUE, message=FALSE}
library(tidyverse)
library(readr)
library(scales)
library(grid)  # for unit()

# CSV already contains: Sample_Det, Tx, Broad_Peaks, Narrow_Peaks
df <- read_csv("data/TOP2B_broad_peaks_before_dedup.csv", show_col_types = FALSE)

# If headers vary slightly, normalize (safe no-ops if not present)
if ("Sample Det" %in% names(df)) df <- df |> rename(Sample_Det = `Sample Det`)
if (!"Tx" %in% names(df) && "Treatment" %in% names(df)) {
  df <- df |> mutate(Tx = if_else(str_detect(Treatment, "DOX", TRUE), "DOX",
                                  if_else(str_detect(Treatment, "VEH", TRUE), "VEH", NA_character_)))
}

plot_df <- df |>
  pivot_longer(c(Broad_Peaks, Narrow_Peaks),
               names_to = "PeakType", values_to = "npeaks") |>
  mutate(
    PeakType   = factor(PeakType, levels = c("Broad_Peaks","Narrow_Peaks")),
    Tx         = factor(Tx, levels = c("VEH","DOX")),
    Sample_Det = factor(Sample_Det, levels = unique(Sample_Det))
  )

# same Y-axis scale for both facets
y_max <- max(plot_df$npeaks, na.rm = TRUE)

p <- ggplot(plot_df, aes(x = Sample_Det, y = npeaks, fill = Tx)) +
  geom_col(width = 0.72) +
  facet_wrap(~ PeakType, ncol = 2, scales = "fixed") +
  scale_x_discrete(limits = levels(plot_df$Sample_Det)) +
  scale_fill_manual(values = c("VEH" = "#3386DD", "DOX" = "#d95f02"), na.value = "grey70") +
  scale_y_continuous(limits = c(0, y_max),
                     expand = expansion(mult = c(0, 0.05)),
                     labels = label_number(big.mark = ",")) +
  labs(
    title = "TOP2B peaks across samples (before deduplication)",
    x = "Sample details",
    y = "Number of peaks",
    fill = "Treatment"
  ) +
  theme_bw(base_size = 14) +
  theme(
    legend.position       = "right",
    legend.title          = element_text(face = "bold"),
    legend.box.background = element_rect(color = "black", size = 0.6),
    legend.background     = element_rect(fill = "white"),
    legend.margin         = margin(6, 6, 6, 6),

    panel.border          = element_rect(color = "black", fill = NA, size = 0.6),
    strip.background      = element_rect(fill = "grey90", color = "black", size = 0.6),
    strip.text            = element_text(face = "bold"),

    panel.grid.minor      = element_blank(),
    panel.spacing         = unit(6, "pt"),
    axis.text.x           = element_text(angle = 45, hjust = 1),

    # optional: center & embolden the title
    plot.title            = element_text(hjust = 0.5, face = "bold", size = 16)
  )

p
```

## **ðŸ“Œ P53 peaks (before deduplication)**
```{r P53, echo=TRUE, message=FALSE}
library(tidyverse)
library(readr)
library(scales)
library(grid)  # for unit()

# CSV should contain: Sample_Det (or "Sample Det"), Tx (or "Treatment"), Peaks
df <- read_csv("data/P53_peaks_before_dedup.csv", show_col_types = FALSE)

# Normalize common header variants (safe no-ops if not present)
if ("Sample Det" %in% names(df)) df <- df |> rename(Sample_Det = `Sample Det`)
if (!"Tx" %in% names(df) && "Treatment" %in% names(df)) {
  df <- df |> mutate(Tx = case_when(
    str_detect(Treatment, regex("VEH", TRUE)) ~ "VEH",
    str_detect(Treatment, regex("DOX", TRUE)) ~ "DOX",
    TRUE ~ NA_character_
  ))
}
# If Tx still missing, try to infer from Sample_Det
if (!"Tx" %in% names(df)) {
  df <- df |> mutate(Tx = case_when(
    str_detect(Sample_Det, regex("\\bVEH\\b", TRUE)) ~ "VEH",
    str_detect(Sample_Det, regex("\\bDOX\\b", TRUE)) ~ "DOX",
    TRUE ~ NA_character_
  ))
}

# Lock X order to the file order
plot_df <- df |>
  mutate(
    Sample_Det = factor(Sample_Det, levels = unique(Sample_Det)),
    Tx         = factor(Tx, levels = c("VEH","DOX"))
  )

p_p53 <- ggplot(plot_df, aes(x = Sample_Det, y = Peaks, fill = Tx)) +
  geom_col(width = 0.72) +
  scale_x_discrete(limits = levels(plot_df$Sample_Det)) +
  scale_fill_manual(values = c("VEH" = "#3386DD", "DOX" = "#d95f02"), na.value = "grey70") +
  scale_y_continuous(labels = scales::label_number(big.mark = ","), 
                     expand = expansion(mult = c(0, 0.05))) +
  labs(
    title = "P53 peaks across samples (before deduplication)",
    x = "Sample details",
    y = "Number of peaks",
    fill = "Treatment"
  ) +
  theme_bw(base_size = 14) +
  theme(
    legend.position       = "right",
    legend.title          = element_text(face = "bold"),
    legend.box.background = element_rect(color = "black", size = 0.6),
    legend.background     = element_rect(fill = "white"),
    panel.border          = element_rect(color = "black", fill = NA, size = 0.6),
    panel.grid.minor      = element_blank(),
    panel.spacing         = unit(6, "pt"),
    axis.text.x           = element_text(angle = 45, hjust = 1),
    plot.title            = element_text(hjust = 0.5, face = "bold", size = 16)  # centered title
  )

p_p53
```

## **ðŸ“Œ TOP2B peaks (After deduplication)**
```{r TOP_dedup, echo=TRUE, message=FALSE}
library(tidyverse)
library(readr)
library(scales)
library(grid)  # for unit()

# CSV already contains: Sample_Det, Tx, Broad_Peaks, Narrow_Peaks
df <- read_csv("data/TOP2B_peaks_after_dedup.csv", show_col_types = FALSE)

# If headers vary slightly, normalize (safe no-ops if not present)
if ("Sample Det" %in% names(df)) df <- df |> rename(Sample_Det = `Sample Det`)
if (!"Tx" %in% names(df) && "Treatment" %in% names(df)) {
  df <- df |> mutate(Tx = if_else(str_detect(Treatment, "DOX", TRUE), "DOX",
                                  if_else(str_detect(Treatment, "VEH", TRUE), "VEH", NA_character_)))
}

plot_df <- df |>
  pivot_longer(c(Broad_Peaks, Narrow_Peaks),
               names_to = "PeakType", values_to = "npeaks") |>
  mutate(
    PeakType   = factor(PeakType, levels = c("Broad_Peaks","Narrow_Peaks")),
    Tx         = factor(Tx, levels = c("VEH","DOX")),
    Sample_Det = factor(Sample_Det, levels = unique(Sample_Det))
  )

# same Y-axis scale for both facets
y_max <- max(plot_df$npeaks, na.rm = TRUE)

p <- ggplot(plot_df, aes(x = Sample_Det, y = npeaks, fill = Tx)) +
  geom_col(width = 0.72) +
  facet_wrap(~ PeakType, ncol = 2, scales = "fixed") +
  scale_x_discrete(limits = levels(plot_df$Sample_Det)) +
  scale_fill_manual(values = c("VEH" = "#3386DD", "DOX" = "#d95f02"), na.value = "grey70") +
  scale_y_continuous(limits = c(0, y_max),
                     expand = expansion(mult = c(0, 0.05)),
                     labels = label_number(big.mark = ",")) +
  labs(
    title = "TOP2B peaks across samples (after deduplication)",
    x = "Sample details",
    y = "Number of peaks",
    fill = "Treatment"
  ) +
  theme_bw(base_size = 14) +
  theme(
    legend.position       = "right",
    legend.title          = element_text(face = "bold"),
    legend.box.background = element_rect(color = "black", size = 0.6),
    legend.background     = element_rect(fill = "white"),
    legend.margin         = margin(6, 6, 6, 6),

    panel.border          = element_rect(color = "black", fill = NA, size = 0.6),
    strip.background      = element_rect(fill = "grey90", color = "black", size = 0.6),
    strip.text            = element_text(face = "bold"),

    panel.grid.minor      = element_blank(),
    panel.spacing         = unit(6, "pt"),
    axis.text.x           = element_text(angle = 45, hjust = 1),

    # optional: center & embolden the title
    plot.title            = element_text(hjust = 0.5, face = "bold", size = 16)
  )

p
```

## **ðŸ“Œ P53 peaks (after deduplication)**
```{r P53_dedup, echo=TRUE, message=FALSE}
library(tidyverse)
library(readr)
library(scales)
library(grid)  # for unit()

# CSV should contain: Sample_Det (or "Sample Det"), Tx (or "Treatment"), Peaks
df <- read_csv("data/P53_peaks_after_dedup.csv", show_col_types = FALSE)

# Normalize common header variants (safe no-ops if not present)
if ("Sample Det" %in% names(df)) df <- df |> rename(Sample_Det = `Sample Det`)
if (!"Tx" %in% names(df) && "Treatment" %in% names(df)) {
  df <- df |> mutate(Tx = case_when(
    str_detect(Treatment, regex("VEH", TRUE)) ~ "VEH",
    str_detect(Treatment, regex("DOX", TRUE)) ~ "DOX",
    TRUE ~ NA_character_
  ))
}
# If Tx still missing, try to infer from Sample_Det
if (!"Tx" %in% names(df)) {
  df <- df |> mutate(Tx = case_when(
    str_detect(Sample_Det, regex("\\bVEH\\b", TRUE)) ~ "VEH",
    str_detect(Sample_Det, regex("\\bDOX\\b", TRUE)) ~ "DOX",
    TRUE ~ NA_character_
  ))
}

# Lock X order to the file order
plot_df <- df |>
  mutate(
    Sample_Det = factor(Sample_Det, levels = unique(Sample_Det)),
    Tx         = factor(Tx, levels = c("VEH","DOX"))
  )

p_p53 <- ggplot(plot_df, aes(x = Sample_Det, y = Peaks, fill = Tx)) +
  geom_col(width = 0.72) +
  scale_x_discrete(limits = levels(plot_df$Sample_Det)) +
  scale_fill_manual(values = c("VEH" = "#3386DD", "DOX" = "#d95f02"), na.value = "grey70") +
  scale_y_continuous(labels = scales::label_number(big.mark = ","), 
                     expand = expansion(mult = c(0, 0.05))) +
  labs(
    title = "P53 peaks across samples (after deduplication)",
    x = "Sample details",
    y = "Number of peaks",
    fill = "Treatment"
  ) +
  theme_bw(base_size = 14) +
  theme(
    legend.position       = "right",
    legend.title          = element_text(face = "bold"),
    legend.box.background = element_rect(color = "black", size = 0.6),
    legend.background     = element_rect(fill = "white"),
    panel.border          = element_rect(color = "black", fill = NA, size = 0.6),
    panel.grid.minor      = element_blank(),
    panel.spacing         = unit(6, "pt"),
    axis.text.x           = element_text(angle = 45, hjust = 1),
    plot.title            = element_text(hjust = 0.5, face = "bold", size = 16)  # centered title
  )

p_p53
```
